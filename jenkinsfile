pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Run Tests') {
            steps {
                sh '''
                python3 -m venv venv
                source venv/bin/activate
                pip install pytest
                pytest --junitxml=report.xml --html=report.html
                '''
            }
        }
        stage('Deploy to Staging') {
            steps {
                sh '''
                scp -r . user@staging-server:/path/to/staging/
                ssh user@staging-server "cd /path/to/staging && ./start.sh"
                '''
            }
        }
        stage('Test in Staging') {
            steps {
                sh '''
                ssh user@staging-server "cd /path/to/staging && ./run-tests.sh"
                '''
            }
        }
        stage('Blue-Green Deployment') {
            steps {
                sh '''
                scp -r . user@green-server:/path/to/green/
                ssh user@green-server "cd /path/to/green && ./start.sh"
                '''
            }
        }
    }
    post {
        success {
            mail to: 'vik.mishra175@gmail.com',
                 subject: "Build Successful: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The build succeeded.\n\nJob: ${env.JOB_NAME}\nBuild Number: ${env.BUILD_NUMBER}"
        }
        failure {
            sh '''
            ssh user@blue-server "cd /path/to/blue && ./rollback.sh"
            '''
            mail to: 'vik.mishra175@gmail.com',
                 subject: "Build Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The build failed.\n\nJob: ${env.JOB_NAME}\nBuild Number: ${env.BUILD_NUMBER}"
        }
    }
}